name: Create VibeStack Coolify Release Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for manual release'
        required: true
        default: 'v0.1.0'
  push:
    branches: [main, master]
    paths: ['.github/workflows/release-packages.yml']

jobs:
  package-vibestack-coolify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set release tag
      id: release_tag
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Create VibeStack Coolify package
      run: |
        echo "📦 Creating VibeStack Coolify package..."
        # Create directory for Coolify deployment
        mkdir -p vibestack-coolify-package
        cp deploy/coolify/*.tf vibestack-coolify-package/
        cp deploy/coolify/schema.yaml vibestack-coolify-package/
        cp deploy/coolify/cloud-init-*.yaml vibestack-coolify-package/ 2>/dev/null || true

        # Create the zip file with vibestack- prefix for consistent naming
        cd vibestack-coolify-package
        zip -r ../vibestack-coolify.zip .
        cd ..

        echo "✅ Created vibestack-coolify.zip (will create 'vibestack-coolify' stack in Resource Manager)"
        ls -la vibestack-coolify.zip

    - name: Show created package
      run: |
        echo "📦 Created package:"
        ls -la vibestack-coolify.zip

        echo -e "\n📋 VibeStack Coolify contents:"
        unzip -l vibestack-coolify.zip

    - name: Upload package to release (if triggered by release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.release.tag_name }}
        files: |
          vibestack-coolify.zip

    - name: Create manual release (if triggered manually)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_tag.outputs.tag_name }}
        name: VibeStack Coolify ${{ steps.release_tag.outputs.tag_name }}
        body: |
          🚀 **VibeStack Coolify - Oracle Cloud Always Free Deployment**

          Deploy Coolify on Oracle Cloud Infrastructure using only Always Free tier resources.

          ## 📦 Deployment Package

          | Package | Resources | Use Case |
          |---------|-----------|----------|
          | **vibestack-coolify.zip** | Coolify server (2 OCPUs, 12GB RAM, 100GB storage) | Self-hosted application platform |

          ## 🚀 Deploy to Oracle Cloud

          [![Deploy to Oracle Cloud](https://oci-resourcemanager-plugin.plugins.oci.oraclecloud.com/latest/deploy-to-oracle-cloud.svg)](https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/${{ github.repository }}/releases/latest/download/vibestack-coolify.zip)

          ## 📋 Prerequisites
          1. Oracle Cloud Always Free account
          2. ED25519 SSH key pair
          3. Cloudflare account (free)
          4. Cloudflare Zero Trust account (for tunnels)
          5. Domain managed by Cloudflare
          6. Cloudflare origin certificate for your domain

          ## 🛠️ What's Included
          - Custom compartment (you name it during deployment)
          - Ubuntu 22.04 LTS (or Oracle Linux option)
          - Public networking with security groups
          - SSH access with your public key
          - Always Free tier compatible - no charges

          ## 🔮 Coming Soon
          - **VibeStack KASM**: Remote workspace server deployment
          - **VibeStack Full**: Combined KASM + Coolify deployment

          ## 📖 Documentation
          See the [repository README](https://github.com/${{ github.repository }}) for detailed setup instructions and documentation.
        files: |
          vibestack-coolify.zip
        draft: false
        prerelease: false

    - name: Verify package contents
      run: |
        echo "📦 Package Verification:"

        REQUIRED_FILES=(
          "providers.tf"
          "variables.tf"
          "outputs.tf"
          "schema.yaml"
          "compute.tf"
          "network.tf"
          "storage.tf"
          "locals.tf"
          "compartment.tf"
          "datasources.tf"
        )

        echo -e "\n✅ Checking vibestack-coolify.zip:"
        for file in "${REQUIRED_FILES[@]}"; do
          if unzip -l "vibestack-coolify.zip" | grep -q "$file"; then
            echo "  ✓ $file"
          else
            echo "  ✗ $file (MISSING)"
          fi
        done

    - name: Summary
      run: |
        echo "🎉 Successfully created VibeStack Coolify deployment package!"
        echo ""
        echo "📦 Generated package:"
        echo "  • vibestack-coolify.zip - VibeStack Coolify deployment"
        echo ""
        echo "🚀 This package will create a Resource Manager stack named: vibestack-coolify"
        echo ""
        echo "📋 Package size:"
        ls -lh vibestack-coolify.zip